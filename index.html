<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡å±•ç¤ºå»Š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        /* é ‚éƒ¨è¼ªæ’­å€åŸŸ */
        .top-carousel {
            position: relative;
            height: 400px;
            background: #000;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-slide.active {
            opacity: 1;
        }

        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #f0f0f0;
        }

        .carousel-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            max-width: 80%;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .carousel-info {
                bottom: 15px;
                left: 15px;
                right: 15px;
                padding: 12px 15px;
                border-radius: 8px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .carousel-info {
                bottom: 10px;
                left: 10px;
                right: 10px;
                padding: 10px 12px;
                border-radius: 6px;
            }
        }

        .carousel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .carousel-views {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        @media (max-width: 768px) {
            .carousel-title {
                font-size: 16px;
                margin-bottom: 4px;
            }
            
            .carousel-views {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .carousel-title {
                font-size: 14px;
                margin-bottom: 3px;
                font-weight: 600;
            }
            
            .carousel-views {
                font-size: 11px;
                opacity: 0.85;
            }
        }

        .carousel-dots {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background: white;
            transform: scale(1.2);
        }

        @media (max-width: 768px) {
            .carousel-dots {
                bottom: 15px;
                right: 15px;
                gap: 8px;
            }

            .carousel-dot {
                width: 8px;
                height: 8px;
            }
        }

        @media (max-width: 480px) {
            .carousel-dots {
                bottom: 10px;
                right: 10px;
                gap: 6px;
            }

            .carousel-dot {
                width: 6px;
                height: 6px;
            }

            .carousel-dot.active {
                transform: scale(1.3);
            }
        }

        /* ç€‘å¸ƒæµä½ˆå±€ */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .gallery-title {
            text-align: center;
            font-size: 32px;
            color: #333;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .masonry-grid {
            column-count: 4;
            column-gap: 20px;
        }

        @media (max-width: 1200px) {
            .masonry-grid {
                column-count: 3;
            }
        }

        @media (max-width: 768px) {
            .masonry-grid {
                column-count: 2;
            }
        }

        @media (max-width: 480px) {
            .masonry-grid {
                column-count: 2;
                column-gap: 10px;
            }

            /* æ‰‹æ©Ÿç‰ˆé¿å…æè¿°æ–‡å­—èˆ‡åœ“é»é‡ç–Š */
            .carousel-info {
                max-width: calc(100% - 80px); /* ç‚ºåœ“é»ç•™å‡ºç©ºé–“ */
            }
        }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 20px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .masonry-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .masonry-item img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
            background: #f0f0f0;
        }

        .masonry-item:hover img {
            transform: scale(1.05);
        }

        .image-info {
            padding: 15px;
            background: white;
        }

        .image-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .image-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }

        .view-count {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .view-icon {
            width: 16px;
            height: 16px;
            fill: #666;
        }

        /* åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 100%;
            max-height: 90vh;
            width: auto;
            height: auto;
            border-radius: 10px;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #ff6b6b;
        }

        .modal-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* åœ–ç‰‡è¼‰å…¥ç‹€æ…‹ */
        .image-loading {
            background: #f0f0f0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .image-loading::after {
            content: "è¼‰å…¥ä¸­...";
            font-size: 14px;
        }

        /* è¼ªæ’­åœ–ç‰‡è¼‰å…¥å„ªåŒ– */
        .carousel-slide img {
            transition: opacity 0.3s ease;
        }

        .carousel-slide img:not([src]) {
            opacity: 0;
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨ç†±é–€åœ–ç‰‡è¼ªæ’­ -->
    <div class="top-carousel">
        <div class="carousel-container" id="carousel">
            <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥ç†±é–€åœ–ç‰‡ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡å±•ç¤ºå€ -->
    <div class="gallery-container">
        <h1 class="gallery-title"> ğŸ˜ğŸ˜ kita bb ğŸ˜ğŸ˜</h1>
        <div class="masonry-grid" id="gallery">
            <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥åœ–ç‰‡ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
    <div class="modal" id="imageModal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-info">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-views" id="modalViews"></div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets æ•´åˆç®¡ç†
        class GoogleSheetsManager {
            constructor() {
                this.scriptUrl = 'https://script.google.com/macros/s/AKfycbzepvHVeOA8oj_ijZSqsyUCDenLfEcEjkrB4DNYIFdGHvjamkkOzPtOVnwVpoXnBv5Uog/exec'; // éœ€è¦æ›¿æ›ç‚ºå¯¦éš›çš„ Apps Script URL
                this.isOnline = false;
            }

            async checkConnection() {
                try {
                    const response = await fetch(`${this.scriptUrl}?action=test`, {
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    this.isOnline = true;
                    return true;
                } catch (error) {
                    console.log('Google Sheets é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜');
                    this.isOnline = false;
                    return false;
                }
            }

            async logView(imageId, imageTitle, timestamp) {
                if (!this.isOnline) return false;

                try {
                    const formData = new FormData();
                    formData.append('action', 'logView');
                    formData.append('imageId', imageId);
                    formData.append('imageTitle', imageTitle);
                    formData.append('timestamp', timestamp);
                    formData.append('userAgent', navigator.userAgent);
                    formData.append('pageUrl', window.location.href);

                    const response = await fetch(this.scriptUrl, {
                        method: 'POST',
                        body: formData,
                        mode: 'no-cors'
                    });
                    
                    console.log('Google Sheets è¨˜éŒ„æˆåŠŸ');
                    return true;
                } catch (error) {
                    console.error('Google Sheets è¨˜éŒ„å¤±æ•—:', error);
                    return false;
                }
            }

            async getViewCounts() {
                if (!this.isOnline) return null;

                try {
                    const response = await fetch(`${this.scriptUrl}?action=getCounts`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    }
                } catch (error) {
                    console.error('ç²å– Google Sheets è¨ˆæ•¸å¤±æ•—:', error);
                }
                
                return null;
            }
        }

        // åœ–ç‰‡æ•¸æ“šç®¡ç†
        class ImageGallery {
            constructor() {
                this.images = [];
                this.topImages = [];
                this.viewCounts = this.loadViewCounts();
                this.googleSheets = new GoogleSheetsManager();
                this.aspectRatios = [
                    { ratio: '16:9', width: 16, height: 9 },
                    { ratio: '9:16', width: 9, height: 16 },
                    { ratio: '4:3', width: 4, height: 3 },
                    { ratio: '3:4', width: 3, height: 4 },
                    { ratio: '1:1', width: 1, height: 1 },
                    { ratio: '3:2', width: 3, height: 2 },
                    { ratio: '2:3', width: 2, height: 3 }
                ];
            }

            async init() {
                // æª¢æŸ¥ Google Sheets é€£ç·š
                await this.googleSheets.checkConnection();
                
                // å¦‚æœ Google Sheets å¯ç”¨ï¼Œå˜—è©¦åŒæ­¥æ•¸æ“š
                if (this.googleSheets.isOnline) {
                    const serverCounts = await this.googleSheets.getViewCounts();
                    if (serverCounts) {
                        // åˆä½µæœ¬åœ°å’Œä¼ºæœå™¨æ•¸æ“š
                        Object.keys(serverCounts).forEach(imageId => {
                            const localCount = this.viewCounts[imageId] || 0;
                            const serverCount = serverCounts[imageId] || 0;
                            this.viewCounts[imageId] = Math.max(localCount, serverCount);
                        });
                        this.saveViewCounts();
                    }
                }
            }

            loadViewCounts() {
                const saved = localStorage.getItem('imageViewCounts');
                return saved ? JSON.parse(saved) : {};
            }

            saveViewCounts() {
                localStorage.setItem('imageViewCounts', JSON.stringify(this.viewCounts));
            }

            async incrementView(imageId, imageTitle) {
                // æ›´æ–°æœ¬åœ°è¨ˆæ•¸
                this.viewCounts[imageId] = (this.viewCounts[imageId] || 0) + 1;
                this.saveViewCounts();
                
                // è¨˜éŒ„åˆ° Google Sheets
                if (this.googleSheets.isOnline) {
                    const timestamp = new Date().toISOString();
                    await this.googleSheets.logView(imageId, imageTitle, timestamp);
                }
                
                return this.viewCounts[imageId];
            }

            getViewCount(imageId) {
                return this.viewCounts[imageId] || 0;
            }

            generateImages(count) {
                const images = [];
                for (let i = 1; i <= count; i++) {
                    const aspectRatio = this.aspectRatios[Math.floor(Math.random() * this.aspectRatios.length)];
                    const baseSize = 400;
                    const width = Math.floor(baseSize * aspectRatio.width);
                    const height = Math.floor(baseSize * aspectRatio.height);
                    
                    // ä½¿ç”¨å›ºå®šçš„ ID å’Œ seedï¼Œç¢ºä¿æ¯æ¬¡åˆ·æ–°é é¢éƒ½æ˜¯åŒä¸€å¼µåœ–ç‰‡
                    const imageId = `img_stable_${i}`;
                    const seed = `stable_image_${i}`;
                    
                    images.push({
                        id: imageId,
                        title: `ç²¾ç¾åœ–ç‰‡ ${i}`,
                        url: `https://picsum.photos/seed/${seed}/${width}/${height}.jpg`,
                        thumbnailUrl: `https://picsum.photos/seed/${seed}/${Math.min(width, 400)}/${Math.min(height, 400)}.jpg`,
                        aspectRatio: aspectRatio.ratio,
                        width: width,
                        height: height,
                        views: this.getViewCount(imageId)
                    });
                }
                return images;
            }

            getTopImages(images, count = 10) {
                return [...images].sort((a, b) => b.views - a.views).slice(0, count);
            }
        }

        // åˆå§‹åŒ–åœ–ç‰‡åº«
        const gallery = new ImageGallery();

        // è¼ªæ’­åŠŸèƒ½
        class Carousel {
            constructor() {
                this.currentIndex = 0;
                this.slides = [];
                this.interval = null;
                this.touchStartX = 0;
                this.touchEndX = 0;
                this.minSwipeDistance = 50;
            }

            init(images) {
                this.slides = images;
                this.render();
                this.startAutoPlay();
            }

            render() {
                const container = document.getElementById('carousel');
                container.innerHTML = '';

                this.slides.forEach((image, index) => {
                    const slide = document.createElement('div');
                    slide.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                    
                    // ç›´æ¥ä½¿ç”¨ HTML å­—ç¬¦ä¸²å‰µå»ºï¼Œé¿å…åœ–ç‰‡è¼‰å…¥å•é¡Œ
                    slide.innerHTML = `
                        <img id="${image.id}" src="${image.url}" alt="${image.title}" loading="lazy">
                        <div class="carousel-info">
                            <div class="carousel-title">${image.title}</div>
                            <div class="carousel-views">ğŸ‘ ${image.views} æ¬¡ç€è¦½</div>
                        </div>
                    `;
                    
                    container.appendChild(slide);
                });

                // æ·»åŠ åœ“é»æŒ‡ç¤ºå™¨
                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'carousel-dots';
                this.slides.forEach((_, index) => {
                    const dot = document.createElement('span');
                    dot.className = `carousel-dot ${index === 0 ? 'active' : ''}`;
                    dot.onclick = () => this.goToSlide(index);
                    dotsContainer.appendChild(dot);
                });
                container.appendChild(dotsContainer);

                // æ·»åŠ è§¸æ§äº‹ä»¶ç›£è½å™¨
                this.addTouchListeners();

                // å»¶é²è™•ç†åœ–ç‰‡è¼‰å…¥éŒ¯èª¤
                setTimeout(() => {
                    this.handleImageErrors();
                }, 500);
            }

            handleImageErrors() {
                const images = document.querySelectorAll('.carousel-slide img');
                images.forEach(img => {
                    if (!img.complete || img.naturalWidth === 0) {
                        console.log('è™•ç†è¼‰å…¥å¤±æ•—çš„è¼ªæ’­åœ–ç‰‡:', img.src);
                        const fallbackSrc = img.src.replace(/\/seed\/[^\/]+\//, '/seed/fallback/');
                        img.src = fallbackSrc;
                    }
                });
            }

            goToSlide(index) {
                const slides = document.querySelectorAll('.carousel-slide');
                const dots = document.querySelectorAll('.carousel-dot');

                slides.forEach(slide => slide.classList.remove('active'));
                dots.forEach(dot => dot.classList.remove('active'));

                this.currentIndex = index;
                slides[index].classList.add('active');
                dots[index].classList.add('active');
            }

            nextSlide() {
                const nextIndex = (this.currentIndex + 1) % this.slides.length;
                this.goToSlide(nextIndex);
            }

            startAutoPlay() {
                this.interval = setInterval(() => this.nextSlide(), 5000);
            }

            stopAutoPlay() {
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }

            addTouchListeners() {
                const container = document.getElementById('carousel');
                
                // è§¸æ§é–‹å§‹
                container.addEventListener('touchstart', (e) => {
                    this.touchStartX = e.touches[0].clientX;
                    this.stopAutoPlay(); // æš«åœè‡ªå‹•æ’­æ”¾
                }, { passive: true });

                // è§¸æ§çµæŸ
                container.addEventListener('touchend', (e) => {
                    this.touchEndX = e.changedTouches[0].clientX;
                    this.handleSwipe();
                    this.startAutoPlay(); // é‡æ–°é–‹å§‹è‡ªå‹•æ’­æ”¾
                }, { passive: true });
            }

            handleSwipe() {
                const swipeDistance = this.touchEndX - this.touchStartX;
                
                // å‘å³æ»‘å‹•ï¼ˆä¸Šä¸€å¼µï¼‰
                if (swipeDistance > this.minSwipeDistance) {
                    const prevIndex = this.currentIndex === 0 ? this.slides.length - 1 : this.currentIndex - 1;
                    this.goToSlide(prevIndex);
                }
                // å‘å·¦æ»‘å‹•ï¼ˆä¸‹ä¸€å¼µï¼‰
                else if (swipeDistance < -this.minSwipeDistance) {
                    this.nextSlide();
                }
            }
        }

        // ç€‘å¸ƒæµæ¸²æŸ“
        function renderGallery(images) {
            const container = document.getElementById('gallery');
            container.innerHTML = '';

            images.forEach(image => {
                const item = document.createElement('div');
                item.className = 'masonry-item';
                item.onclick = () => openModal(image);

                item.innerHTML = `
                    <img id="${image.id}" src="${image.thumbnailUrl}" alt="${image.title}" loading="lazy">
                    <div class="image-info">
                        <div class="image-title">${image.title}</div>
                        <div class="image-stats">
                            <span class="view-count">
                                <svg class="view-icon" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                ${image.views}
                            </span>
                            <span>${image.aspectRatio}</span>
                        </div>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        // æ¨¡æ…‹æ¡†åŠŸèƒ½
        function openModal(image) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalViews = document.getElementById('modalViews');

            // å¢åŠ ç€è¦½æ¬¡æ•¸
            const newViewCount = gallery.incrementView(image.id);
            
            // è¨­ç½®åœ–ç‰‡æºï¼Œä½¿ç”¨è¼ƒå¤§çš„å°ºå¯¸ä»¥ç¢ºä¿æ¸…æ™°åº¦
            const largeWidth = Math.min(image.width * 2, 1920);
            const largeHeight = Math.min(image.height * 2, 1080);
            const seed = image.url.match(/\/seed\/([^\/]+)\//)[1];
            modalImage.src = `https://picsum.photos/seed/${seed}/${largeWidth}/${largeHeight}.jpg`;
            modalImage.setAttribute('data-image-id', image.id);
            
            modalTitle.textContent = image.title;
            modalViews.textContent = `ğŸ‘ ${newViewCount} æ¬¡ç€è¦½`;

            modal.classList.add('active');

            // æ›´æ–°é¡¯ç¤ºçš„ç€è¦½æ¬¡æ•¸
            setTimeout(() => updateViewCounts(), 100);
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }

        // æ›´æ–°ç€è¦½æ¬¡æ•¸é¡¯ç¤º
        function updateViewCounts() {
            // æ›´æ–°æ‰€æœ‰åœ–ç‰‡çš„ç€è¦½æ¬¡æ•¸
            gallery.images.forEach(image => {
                image.views = gallery.getViewCount(image.id);
            });

            // æ›´æ–°ç€‘å¸ƒæµä¸­çš„ç€è¦½æ¬¡æ•¸ï¼Œä½¿ç”¨åœ–ç‰‡ ID è€Œéç´¢å¼•
            gallery.images.forEach(image => {
                const imgElement = document.getElementById(image.id);
                if (imgElement) {
                    const viewCountElement = imgElement.closest('.masonry-item')?.querySelector('.view-count');
                    if (viewCountElement) {
                        const viewCount = gallery.getViewCount(image.id);
                        viewCountElement.innerHTML = `
                            <svg class="view-icon" viewBox="0 0 24 24">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                            ${viewCount}
                        `;
                    }
                }
            });

            // æ›´æ–°è¼ªæ’­ä¸­çš„ç€è¦½æ¬¡æ•¸
            gallery.topImages.forEach(image => {
                const imgElement = document.getElementById(image.id);
                if (imgElement) {
                    const viewCountElement = imgElement.closest('.carousel-slide')?.querySelector('.carousel-views');
                    if (viewCountElement) {
                        const viewCount = gallery.getViewCount(image.id);
                        viewCountElement.textContent = `ğŸ‘ ${viewCount} æ¬¡ç€è¦½`;
                    }
                }
            });

            // æ›´æ–°æ¨¡æ…‹æ¡†ä¸­çš„ç€è¦½æ¬¡æ•¸ï¼ˆå¦‚æœæ‰“é–‹ï¼‰
            const modalImage = document.getElementById('modalImage');
            if (modalImage && modalImage.getAttribute('data-image-id')) {
                const imageId = modalImage.getAttribute('data-image-id');
                const modalViews = document.getElementById('modalViews');
                if (modalViews) {
                    const viewCount = gallery.getViewCount(imageId);
                    modalViews.textContent = `ğŸ‘ ${viewCount} æ¬¡ç€è¦½`;
                }
            }
        }

        // éµç›¤äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯é—œé–‰
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal' || e.target.classList.contains('modal-content')) {
                closeModal();
            }
        });

        // åœ–ç‰‡è¼‰å…¥éŒ¯èª¤è™•ç†
        function handleImageError(img, fallbackUrl, retryCount = 0) {
            const maxRetries = 2;
            
            img.onerror = function() {
                console.log(`åœ–ç‰‡è¼‰å…¥å¤±æ•— (å˜—è©¦ ${retryCount + 1}/${maxRetries + 1}):`, img.src);
                
                if (retryCount < maxRetries) {
                    // å»¶é²é‡è©¦
                    setTimeout(() => {
                        console.log('é‡æ–°è¼‰å…¥åœ–ç‰‡...');
                        img.src = img.src + '&retry=' + Date.now();
                        handleImageError(img, fallbackUrl, retryCount + 1);
                    }, 1000 * (retryCount + 1)); // éå¢å»¶é²æ™‚é–“
                } else {
                    // è¶…éé‡è©¦æ¬¡æ•¸ï¼Œä½¿ç”¨å‚™ç”¨åœ–ç‰‡
                    console.log('ä½¿ç”¨å‚™ç”¨åœ–ç‰‡');
                    img.src = fallbackUrl;
                    img.onerror = null;
                }
            };

            // è¨­ç½®è¼‰å…¥è¶…æ™‚
            img.onload = function() {
                console.log('åœ–ç‰‡è¼‰å…¥æˆåŠŸ:', img.src);
            };

            // è¨­ç½®è¼‰å…¥è¶…æ™‚ï¼ˆ5ç§’ï¼‰
            setTimeout(() => {
                if (!img.complete) {
                    console.log('åœ–ç‰‡è¼‰å…¥è¶…æ™‚ï¼Œè§¸ç™¼éŒ¯èª¤è™•ç†');
                    img.onerror();
                }
            }, 5000);
        }

        // åˆå§‹åŒ–
        let carousel;

        async function initGallery() {
            try {
                // ç”Ÿæˆåœ–ç‰‡æ•¸æ“š
                gallery.images = gallery.generateImages(30);
                
                // ç²å–ç†±é–€åœ–ç‰‡
                gallery.topImages = gallery.getTopImages(gallery.images, 10);
                
                // åˆå§‹åŒ–è¼ªæ’­
                carousel = new Carousel();
                carousel.init(gallery.topImages);
                
                // æ¸²æŸ“ç•«å»Š
                renderGallery(gallery.images);
                
                // æ·»åŠ åœ–ç‰‡éŒ¯èª¤è™•ç†ï¼ˆåƒ…é‡å°ç€‘å¸ƒæµåœ–ç‰‡ï¼‰
                setTimeout(() => {
                    document.querySelectorAll('.masonry-item img').forEach(img => {
                        const currentSrc = img.src;
                        const fallbackSrc = currentSrc.replace(/\/seed\/[^\/]+\//, '/seed/fallback/');
                        handleImageError(img, fallbackSrc);
                    });
                }, 200);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('carousel').innerHTML = '<div class="loading"><p>è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p></div>';
                document.getElementById('gallery').innerHTML = '<div class="loading"><p>è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p></div>';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await gallery.init();
            await initGallery();
        });
    </script>
</body>
</html>