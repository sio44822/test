<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂúñÁâáÂ±ïÁ§∫Âªä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        /* È†ÇÈÉ®Ëº™Êí≠ÂçÄÂüü */
        .top-carousel {
            position: relative;
            height: 400px;
            background: #000;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-slide.active {
            opacity: 1;
        }

        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #f0f0f0;
        }

        .carousel-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .carousel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .carousel-views {
            font-size: 14px;
            opacity: 0.9;
        }

        .carousel-dots {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background: white;
            transform: scale(1.2);
        }

        /* ÁÄëÂ∏ÉÊµÅ‰ΩàÂ±Ä */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .gallery-title {
            text-align: center;
            font-size: 32px;
            color: #333;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .masonry-grid {
            column-count: 4;
            column-gap: 20px;
        }

        @media (max-width: 1200px) {
            .masonry-grid {
                column-count: 3;
            }
        }

        @media (max-width: 768px) {
            .masonry-grid {
                column-count: 2;
            }
        }

        @media (max-width: 480px) {
            .masonry-grid {
                column-count: 1;
            }
        }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 20px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .masonry-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .masonry-item img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
            background: #f0f0f0;
        }

        .masonry-item:hover img {
            transform: scale(1.05);
        }

        .image-info {
            padding: 15px;
            background: white;
        }

        .image-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .image-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }

        .view-count {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .view-icon {
            width: 16px;
            height: 16px;
            fill: #666;
        }

        /* ÂúñÁâáÊîæÂ§ßÊ®°ÊÖãÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 100%;
            max-height: 90vh;
            width: auto;
            height: auto;
            border-radius: 10px;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #ff6b6b;
        }

        .modal-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        /* ËºâÂÖ•ÂãïÁï´ */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- È†ÇÈÉ®ÁÜ±ÈñÄÂúñÁâáËº™Êí≠ -->
    <div class="top-carousel">
        <div class="carousel-container" id="carousel">
            <div class="loading">
                <div class="spinner"></div>
                <p>ËºâÂÖ•ÁÜ±ÈñÄÂúñÁâá‰∏≠...</p>
            </div>
        </div>
    </div>

    <!-- ÂúñÁâáÂ±ïÁ§∫ÂçÄ -->
    <div class="gallery-container">
        <h1 class="gallery-title">üì∏ Á≤æÈÅ∏ÂúñÁâáÈõÜ</h1>
        <div class="masonry-grid" id="gallery">
            <div class="loading">
                <div class="spinner"></div>
                <p>ËºâÂÖ•ÂúñÁâá‰∏≠...</p>
            </div>
        </div>
    </div>

    <!-- ÂúñÁâáÊîæÂ§ßÊ®°ÊÖãÊ°Ü -->
    <div class="modal" id="imageModal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-info">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-views" id="modalViews"></div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Êï¥ÂêàÁÆ°ÁêÜ
        class GoogleSheetsManager {
            constructor() {
                this.scriptUrl = 'https://script.google.com/macros/s/AKfycbzepvHVeOA8oj_ijZSqsyUCDenLfEcEjkrB4DNYIFdGHvjamkkOzPtOVnwVpoXnBv5Uog/exec'; // ÈúÄË¶ÅÊõøÊèõÁÇ∫ÂØ¶ÈöõÁöÑ Apps Script URL
                this.isOnline = false;
            }

            async checkConnection() {
                try {
                    const response = await fetch(`${this.scriptUrl}?action=test`, {
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    this.isOnline = true;
                    return true;
                } catch (error) {
                    console.log('Google Sheets ÈÄ£Á∑öÂ§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞ÂÑ≤Â≠ò');
                    this.isOnline = false;
                    return false;
                }
            }

            async logView(imageId, imageTitle, timestamp) {
                if (!this.isOnline) return false;

                try {
                    const formData = new FormData();
                    formData.append('action', 'logView');
                    formData.append('imageId', imageId);
                    formData.append('imageTitle', imageTitle);
                    formData.append('timestamp', timestamp);
                    formData.append('userAgent', navigator.userAgent);
                    formData.append('pageUrl', window.location.href);

                    const response = await fetch(this.scriptUrl, {
                        method: 'POST',
                        body: formData,
                        mode: 'no-cors'
                    });
                    
                    console.log('Google Sheets Ë®òÈåÑÊàêÂäü');
                    return true;
                } catch (error) {
                    console.error('Google Sheets Ë®òÈåÑÂ§±Êïó:', error);
                    return false;
                }
            }

            async getViewCounts() {
                if (!this.isOnline) return null;

                try {
                    const response = await fetch(`${this.scriptUrl}?action=getCounts`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    }
                } catch (error) {
                    console.error('Áç≤Âèñ Google Sheets Ë®àÊï∏Â§±Êïó:', error);
                }
                
                return null;
            }
        }

        // ÂúñÁâáÊï∏ÊìöÁÆ°ÁêÜ
        class ImageGallery {
            constructor() {
                this.images = [];
                this.topImages = [];
                this.viewCounts = this.loadViewCounts();
                this.googleSheets = new GoogleSheetsManager();
                this.aspectRatios = [
                    { ratio: '16:9', width: 16, height: 9 },
                    { ratio: '9:16', width: 9, height: 16 },
                    { ratio: '4:3', width: 4, height: 3 },
                    { ratio: '3:4', width: 3, height: 4 },
                    { ratio: '1:1', width: 1, height: 1 },
                    { ratio: '3:2', width: 3, height: 2 },
                    { ratio: '2:3', width: 2, height: 3 }
                ];
            }

            async init() {
                // Ê™¢Êü• Google Sheets ÈÄ£Á∑ö
                await this.googleSheets.checkConnection();
                
                // Â¶ÇÊûú Google Sheets ÂèØÁî®ÔºåÂòóË©¶ÂêåÊ≠•Êï∏Êìö
                if (this.googleSheets.isOnline) {
                    const serverCounts = await this.googleSheets.getViewCounts();
                    if (serverCounts) {
                        // Âêà‰ΩµÊú¨Âú∞Âíå‰º∫ÊúçÂô®Êï∏Êìö
                        Object.keys(serverCounts).forEach(imageId => {
                            const localCount = this.viewCounts[imageId] || 0;
                            const serverCount = serverCounts[imageId] || 0;
                            this.viewCounts[imageId] = Math.max(localCount, serverCount);
                        });
                        this.saveViewCounts();
                    }
                }
            }

            loadViewCounts() {
                const saved = localStorage.getItem('imageViewCounts');
                return saved ? JSON.parse(saved) : {};
            }

            saveViewCounts() {
                localStorage.setItem('imageViewCounts', JSON.stringify(this.viewCounts));
            }

            async incrementView(imageId, imageTitle) {
                // Êõ¥Êñ∞Êú¨Âú∞Ë®àÊï∏
                this.viewCounts[imageId] = (this.viewCounts[imageId] || 0) + 1;
                this.saveViewCounts();
                
                // Ë®òÈåÑÂà∞ Google Sheets
                if (this.googleSheets.isOnline) {
                    const timestamp = new Date().toISOString();
                    await this.googleSheets.logView(imageId, imageTitle, timestamp);
                }
                
                return this.viewCounts[imageId];
            }

            getViewCount(imageId) {
                return this.viewCounts[imageId] || 0;
            }

            generateImages(count) {
                const images = [];
                for (let i = 1; i <= count; i++) {
                    const aspectRatio = this.aspectRatios[Math.floor(Math.random() * this.aspectRatios.length)];
                    const baseSize = 400;
                    const width = Math.floor(baseSize * aspectRatio.width);
                    const height = Math.floor(baseSize * aspectRatio.height);
                    
                    // ‰ΩøÁî®Âõ∫ÂÆöÁöÑ ID Âíå seedÔºåÁ¢∫‰øùÊØèÊ¨°Âà∑Êñ∞È†ÅÈù¢ÈÉΩÊòØÂêå‰∏ÄÂºµÂúñÁâá
                    const imageId = `img_stable_${i}`;
                    const seed = `stable_image_${i}`;
                    
                    images.push({
                        id: imageId,
                        title: `Á≤æÁæéÂúñÁâá ${i}`,
                        url: `https://picsum.photos/seed/${seed}/${width}/${height}.jpg`,
                        thumbnailUrl: `https://picsum.photos/seed/${seed}/${Math.min(width, 400)}/${Math.min(height, 400)}.jpg`,
                        aspectRatio: aspectRatio.ratio,
                        width: width,
                        height: height,
                        views: this.getViewCount(imageId)
                    });
                }
                return images;
            }

            getTopImages(images, count = 10) {
                return [...images].sort((a, b) => b.views - a.views).slice(0, count);
            }
        }

        // ÂàùÂßãÂåñÂúñÁâáÂ∫´
        const gallery = new ImageGallery();

        // Ëº™Êí≠ÂäüËÉΩ
        class Carousel {
            constructor() {
                this.currentIndex = 0;
                this.slides = [];
                this.interval = null;
            }

            init(images) {
                this.slides = images;
                this.render();
                this.startAutoPlay();
            }

            render() {
                const container = document.getElementById('carousel');
                container.innerHTML = '';

                this.slides.forEach((image, index) => {
                    const slide = document.createElement('div');
                    slide.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                    slide.innerHTML = `
                        <img id="${image.id}" src="${image.url}" alt="${image.title}">
                        <div class="carousel-info">
                            <div class="carousel-title">${image.title}</div>
                            <div class="carousel-views">üëÅ ${image.views} Ê¨°ÁÄèË¶Ω</div>
                        </div>
                    `;
                    container.appendChild(slide);
                });

                // Ê∑ªÂä†ÂúìÈªûÊåáÁ§∫Âô®
                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'carousel-dots';
                this.slides.forEach((_, index) => {
                    const dot = document.createElement('span');
                    dot.className = `carousel-dot ${index === 0 ? 'active' : ''}`;
                    dot.onclick = () => this.goToSlide(index);
                    dotsContainer.appendChild(dot);
                });
                container.appendChild(dotsContainer);
            }

            goToSlide(index) {
                const slides = document.querySelectorAll('.carousel-slide');
                const dots = document.querySelectorAll('.carousel-dot');

                slides.forEach(slide => slide.classList.remove('active'));
                dots.forEach(dot => dot.classList.remove('active'));

                this.currentIndex = index;
                slides[index].classList.add('active');
                dots[index].classList.add('active');
            }

            nextSlide() {
                const nextIndex = (this.currentIndex + 1) % this.slides.length;
                this.goToSlide(nextIndex);
            }

            startAutoPlay() {
                this.interval = setInterval(() => this.nextSlide(), 5000);
            }

            stopAutoPlay() {
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
        }

        // ÁÄëÂ∏ÉÊµÅÊ∏≤Êüì
        function renderGallery(images) {
            const container = document.getElementById('gallery');
            container.innerHTML = '';

            images.forEach(image => {
                const item = document.createElement('div');
                item.className = 'masonry-item';
                item.onclick = () => openModal(image);

                item.innerHTML = `
                    <img id="${image.id}" src="${image.thumbnailUrl}" alt="${image.title}" loading="lazy">
                    <div class="image-info">
                        <div class="image-title">${image.title}</div>
                        <div class="image-stats">
                            <span class="view-count">
                                <svg class="view-icon" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                ${image.views}
                            </span>
                            <span>${image.aspectRatio}</span>
                        </div>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        // Ê®°ÊÖãÊ°ÜÂäüËÉΩ
        function openModal(image) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalViews = document.getElementById('modalViews');

            // Â¢ûÂä†ÁÄèË¶ΩÊ¨°Êï∏
            const newViewCount = gallery.incrementView(image.id);
            
            // Ë®≠ÁΩÆÂúñÁâáÊ∫êÔºå‰ΩøÁî®ËºÉÂ§ßÁöÑÂ∞∫ÂØ∏‰ª•Á¢∫‰øùÊ∏ÖÊô∞Â∫¶
            const largeWidth = Math.min(image.width * 2, 1920);
            const largeHeight = Math.min(image.height * 2, 1080);
            const seed = image.url.match(/\/seed\/([^\/]+)\//)[1];
            modalImage.src = `https://picsum.photos/seed/${seed}/${largeWidth}/${largeHeight}.jpg`;
            modalImage.setAttribute('data-image-id', image.id);
            
            modalTitle.textContent = image.title;
            modalViews.textContent = `üëÅ ${newViewCount} Ê¨°ÁÄèË¶Ω`;

            modal.classList.add('active');

            // Êõ¥Êñ∞È°ØÁ§∫ÁöÑÁÄèË¶ΩÊ¨°Êï∏
            setTimeout(() => updateViewCounts(), 100);
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }

        // Êõ¥Êñ∞ÁÄèË¶ΩÊ¨°Êï∏È°ØÁ§∫
        function updateViewCounts() {
            // Êõ¥Êñ∞ÊâÄÊúâÂúñÁâáÁöÑÁÄèË¶ΩÊ¨°Êï∏
            gallery.images.forEach(image => {
                image.views = gallery.getViewCount(image.id);
            });

            // Êõ¥Êñ∞ÁÄëÂ∏ÉÊµÅ‰∏≠ÁöÑÁÄèË¶ΩÊ¨°Êï∏Ôºå‰ΩøÁî®ÂúñÁâá ID ËÄåÈùûÁ¥¢Âºï
            gallery.images.forEach(image => {
                const imgElement = document.getElementById(image.id);
                if (imgElement) {
                    const viewCountElement = imgElement.closest('.masonry-item')?.querySelector('.view-count');
                    if (viewCountElement) {
                        const viewCount = gallery.getViewCount(image.id);
                        viewCountElement.innerHTML = `
                            <svg class="view-icon" viewBox="0 0 24 24">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                            ${viewCount}
                        `;
                    }
                }
            });

            // Êõ¥Êñ∞Ëº™Êí≠‰∏≠ÁöÑÁÄèË¶ΩÊ¨°Êï∏
            gallery.topImages.forEach(image => {
                const imgElement = document.getElementById(image.id);
                if (imgElement) {
                    const viewCountElement = imgElement.closest('.carousel-slide')?.querySelector('.carousel-views');
                    if (viewCountElement) {
                        const viewCount = gallery.getViewCount(image.id);
                        viewCountElement.textContent = `üëÅ ${viewCount} Ê¨°ÁÄèË¶Ω`;
                    }
                }
            });

            // Êõ¥Êñ∞Ê®°ÊÖãÊ°Ü‰∏≠ÁöÑÁÄèË¶ΩÊ¨°Êï∏ÔºàÂ¶ÇÊûúÊâìÈñãÔºâ
            const modalImage = document.getElementById('modalImage');
            if (modalImage && modalImage.getAttribute('data-image-id')) {
                const imageId = modalImage.getAttribute('data-image-id');
                const modalViews = document.getElementById('modalViews');
                if (modalViews) {
                    const viewCount = gallery.getViewCount(imageId);
                    modalViews.textContent = `üëÅ ${viewCount} Ê¨°ÁÄèË¶Ω`;
                }
            }
        }

        // ÈçµÁõ§‰∫ã‰ª∂
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ÈªûÊìäÊ®°ÊÖãÊ°ÜËÉåÊôØÈóúÈñâ
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal' || e.target.classList.contains('modal-content')) {
                closeModal();
            }
        });

        // ÂúñÁâáËºâÂÖ•ÈåØË™§ËôïÁêÜ
        function handleImageError(img, fallbackUrl) {
            img.onerror = function() {
                console.log('ÂúñÁâáËºâÂÖ•Â§±ÊïóÔºå‰ΩøÁî®ÂÇôÁî®ÂúñÁâá');
                img.src = fallbackUrl;
                img.onerror = null; // ÈÅøÂÖçÁÑ°ÈôêÂæ™Áí∞
            };
        }

        // ÂàùÂßãÂåñ
        let carousel;

        async function initGallery() {
            try {
                // ÁîüÊàêÂúñÁâáÊï∏Êìö
                gallery.images = gallery.generateImages(30);
                
                // Áç≤ÂèñÁÜ±ÈñÄÂúñÁâá
                gallery.topImages = gallery.getTopImages(gallery.images, 10);
                
                // ÂàùÂßãÂåñËº™Êí≠
                carousel = new Carousel();
                carousel.init(gallery.topImages);
                
                // Ê∏≤ÊüìÁï´Âªä
                renderGallery(gallery.images);
                
                // Ê∑ªÂä†ÂúñÁâáÈåØË™§ËôïÁêÜ
                setTimeout(() => {
                    document.querySelectorAll('img').forEach(img => {
                        const currentSrc = img.src;
                        const fallbackSrc = currentSrc.replace(/\/seed\/[^\/]+\//, '/seed/fallback/');
                        handleImageError(img, fallbackSrc);
                    });
                }, 1000);
                
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ§±Êïó:', error);
                document.getElementById('carousel').innerHTML = '<div class="loading"><p>ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢</p></div>';
                document.getElementById('gallery').innerHTML = '<div class="loading"><p>ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢</p></div>';
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            await gallery.init();
            await initGallery();
        });
    </script>
</body>
</html>