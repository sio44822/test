<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡å±•ç¤ºå»Š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        /* é ‚éƒ¨è¼ªæ’­å€åŸŸ */
        .top-carousel {
            position: relative;
            height: 400px;
            background: #000;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-slide.active {
            opacity: 1;
        }

        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #f0f0f0;
        }

        .carousel-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .carousel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .carousel-views {
            font-size: 14px;
            opacity: 0.9;
        }

        .carousel-dots {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background: white;
            transform: scale(1.2);
        }

        /* ç€‘å¸ƒæµä½ˆå±€ */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .gallery-title {
            text-align: center;
            font-size: 32px;
            color: #333;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .masonry-grid {
            column-count: 4;
            column-gap: 20px;
        }

        @media (max-width: 1200px) {
            .masonry-grid {
                column-count: 3;
            }
        }

        @media (max-width: 768px) {
            .masonry-grid {
                column-count: 2;
            }
        }

        @media (max-width: 480px) {
            .masonry-grid {
                column-count: 1;
            }
        }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 20px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .masonry-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .masonry-item img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
            background: #f0f0f0;
        }

        .masonry-item:hover img {
            transform: scale(1.05);
        }

        .image-info {
            padding: 15px;
            background: white;
        }

        .image-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .image-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }

        .view-count {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .view-icon {
            width: 16px;
            height: 16px;
            fill: #666;
        }

        /* åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 100%;
            max-height: 90vh;
            width: auto;
            height: auto;
            border-radius: 10px;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #ff6b6b;
        }

        .modal-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨ç†±é–€åœ–ç‰‡è¼ªæ’­ -->
    <div class="top-carousel">
        <div class="carousel-container" id="carousel">
            <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥ç†±é–€åœ–ç‰‡ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡å±•ç¤ºå€ -->
    <div class="gallery-container">
        <h1 class="gallery-title">ğŸ“¸ ç²¾é¸åœ–ç‰‡é›†</h1>
        <div class="masonry-grid" id="gallery">
            <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥åœ–ç‰‡ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
    <div class="modal" id="imageModal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-info">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-views" id="modalViews"></div>
            </div>
        </div>
    </div>

    <script>
        // åœ–ç‰‡æ•¸æ“šç®¡ç†
        class ImageGallery {
            constructor() {
                this.images = [];
                this.topImages = [];
                this.viewCounts = this.loadViewCounts();
                this.aspectRatios = [
                    { ratio: '16:9', width: 16, height: 9 },
                    { ratio: '9:16', width: 9, height: 16 },
                    { ratio: '4:3', width: 4, height: 3 },
                    { ratio: '3:4', width: 3, height: 4 },
                    { ratio: '1:1', width: 1, height: 1 },
                    { ratio: '3:2', width: 3, height: 2 },
                    { ratio: '2:3', width: 2, height: 3 }
                ];
            }

            loadViewCounts() {
                const saved = localStorage.getItem('imageViewCounts');
                return saved ? JSON.parse(saved) : {};
            }

            saveViewCounts() {
                localStorage.setItem('imageViewCounts', JSON.stringify(this.viewCounts));
            }

            incrementView(imageId) {
                this.viewCounts[imageId] = (this.viewCounts[imageId] || 0) + 1;
                this.saveViewCounts();
                return this.viewCounts[imageId];
            }

            getViewCount(imageId) {
                return this.viewCounts[imageId] || 0;
            }

            generateImages(count) {
                const images = [];
                for (let i = 1; i <= count; i++) {
                    const aspectRatio = this.aspectRatios[Math.floor(Math.random() * this.aspectRatios.length)];
                    const baseSize = 400;
                    const width = Math.floor(baseSize * aspectRatio.width);
                    const height = Math.floor(baseSize * aspectRatio.height);
                    
                    const imageId = `img_${Date.now()}_${i}`;
                    const seed = Math.random().toString(36).substring(7);
                    
                    images.push({
                        id: imageId,
                        title: `ç²¾ç¾åœ–ç‰‡ ${i}`,
                        url: `https://picsum.photos/seed/${seed}/${width}/${height}.jpg`,
                        thumbnailUrl: `https://picsum.photos/seed/${seed}/${Math.min(width, 400)}/${Math.min(height, 400)}.jpg`,
                        aspectRatio: aspectRatio.ratio,
                        width: width,
                        height: height,
                        views: this.getViewCount(imageId)
                    });
                }
                return images;
            }

            getTopImages(images, count = 10) {
                return [...images].sort((a, b) => b.views - a.views).slice(0, count);
            }
        }

        // åˆå§‹åŒ–åœ–ç‰‡åº«
        const gallery = new ImageGallery();

        // è¼ªæ’­åŠŸèƒ½
        class Carousel {
            constructor() {
                this.currentIndex = 0;
                this.slides = [];
                this.interval = null;
            }

            init(images) {
                this.slides = images;
                this.render();
                this.startAutoPlay();
            }

            render() {
                const container = document.getElementById('carousel');
                container.innerHTML = '';

                this.slides.forEach((image, index) => {
                    const slide = document.createElement('div');
                    slide.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                    slide.innerHTML = `
                        <img src="${image.url}" alt="${image.title}">
                        <div class="carousel-info">
                            <div class="carousel-title">${image.title}</div>
                            <div class="carousel-views">ğŸ‘ ${image.views} æ¬¡ç€è¦½</div>
                        </div>
                    `;
                    container.appendChild(slide);
                });

                // æ·»åŠ åœ“é»æŒ‡ç¤ºå™¨
                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'carousel-dots';
                this.slides.forEach((_, index) => {
                    const dot = document.createElement('span');
                    dot.className = `carousel-dot ${index === 0 ? 'active' : ''}`;
                    dot.onclick = () => this.goToSlide(index);
                    dotsContainer.appendChild(dot);
                });
                container.appendChild(dotsContainer);
            }

            goToSlide(index) {
                const slides = document.querySelectorAll('.carousel-slide');
                const dots = document.querySelectorAll('.carousel-dot');

                slides.forEach(slide => slide.classList.remove('active'));
                dots.forEach(dot => dot.classList.remove('active'));

                this.currentIndex = index;
                slides[index].classList.add('active');
                dots[index].classList.add('active');
            }

            nextSlide() {
                const nextIndex = (this.currentIndex + 1) % this.slides.length;
                this.goToSlide(nextIndex);
            }

            startAutoPlay() {
                this.interval = setInterval(() => this.nextSlide(), 5000);
            }

            stopAutoPlay() {
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
        }

        // ç€‘å¸ƒæµæ¸²æŸ“
        function renderGallery(images) {
            const container = document.getElementById('gallery');
            container.innerHTML = '';

            images.forEach(image => {
                const item = document.createElement('div');
                item.className = 'masonry-item';
                item.onclick = () => openModal(image);

                item.innerHTML = `
                    <img src="${image.thumbnailUrl}" alt="${image.title}" loading="lazy">
                    <div class="image-info">
                        <div class="image-title">${image.title}</div>
                        <div class="image-stats">
                            <span class="view-count">
                                <svg class="view-icon" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                ${image.views}
                            </span>
                            <span>${image.aspectRatio}</span>
                        </div>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        // æ¨¡æ…‹æ¡†åŠŸèƒ½
        function openModal(image) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalViews = document.getElementById('modalViews');

            // å¢åŠ ç€è¦½æ¬¡æ•¸
            const newViewCount = gallery.incrementView(image.id);
            
            // è¨­ç½®åœ–ç‰‡æºï¼Œä½¿ç”¨è¼ƒå¤§çš„å°ºå¯¸ä»¥ç¢ºä¿æ¸…æ™°åº¦
            const largeWidth = Math.min(image.width * 2, 1920);
            const largeHeight = Math.min(image.height * 2, 1080);
            const seed = image.url.match(/\/seed\/([^\/]+)\//)[1];
            modalImage.src = `https://picsum.photos/seed/${seed}/${largeWidth}/${largeHeight}.jpg`;
            
            modalTitle.textContent = image.title;
            modalViews.textContent = `ğŸ‘ ${newViewCount} æ¬¡ç€è¦½`;

            modal.classList.add('active');

            // æ›´æ–°é¡¯ç¤ºçš„ç€è¦½æ¬¡æ•¸
            setTimeout(() => updateViewCounts(), 100);
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }

        // æ›´æ–°ç€è¦½æ¬¡æ•¸é¡¯ç¤º
        function updateViewCounts() {
            // æ›´æ–°æ‰€æœ‰åœ–ç‰‡çš„ç€è¦½æ¬¡æ•¸
            gallery.images.forEach(image => {
                image.views = gallery.getViewCount(image.id);
            });

            // æ›´æ–°ç•¶å‰é¡¯ç¤ºçš„ç€è¦½æ¬¡æ•¸ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹é é¢
            document.querySelectorAll('.view-count').forEach((element, index) => {
                const imageId = gallery.images[index]?.id;
                if (imageId) {
                    const viewCount = gallery.getViewCount(imageId);
                    element.innerHTML = `
                        <svg class="view-icon" viewBox="0 0 24 24">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                        ${viewCount}
                    `;
                }
            });

            // æ›´æ–°è¼ªæ’­ä¸­çš„ç€è¦½æ¬¡æ•¸
            document.querySelectorAll('.carousel-views').forEach((element, index) => {
                if (gallery.topImages[index]) {
                    element.textContent = `ğŸ‘ ${gallery.topImages[index].views} æ¬¡ç€è¦½`;
                }
            });
        }

        // éµç›¤äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯é—œé–‰
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal' || e.target.classList.contains('modal-content')) {
                closeModal();
            }
        });

        // åœ–ç‰‡è¼‰å…¥éŒ¯èª¤è™•ç†
        function handleImageError(img, fallbackUrl) {
            img.onerror = function() {
                console.log('åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨åœ–ç‰‡');
                img.src = fallbackUrl;
                img.onerror = null; // é¿å…ç„¡é™å¾ªç’°
            };
        }

        // åˆå§‹åŒ–
        let carousel;

        async function initGallery() {
            try {
                // ç”Ÿæˆåœ–ç‰‡æ•¸æ“š
                gallery.images = gallery.generateImages(30);
                
                // ç²å–ç†±é–€åœ–ç‰‡
                gallery.topImages = gallery.getTopImages(gallery.images, 10);
                
                // åˆå§‹åŒ–è¼ªæ’­
                carousel = new Carousel();
                carousel.init(gallery.topImages);
                
                // æ¸²æŸ“ç•«å»Š
                renderGallery(gallery.images);
                
                // æ·»åŠ åœ–ç‰‡éŒ¯èª¤è™•ç†
                setTimeout(() => {
                    document.querySelectorAll('img').forEach(img => {
                        const currentSrc = img.src;
                        const fallbackSrc = currentSrc.replace(/\/seed\/[^\/]+\//, '/seed/fallback/');
                        handleImageError(img, fallbackSrc);
                    });
                }, 1000);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('carousel').innerHTML = '<div class="loading"><p>è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p></div>';
                document.getElementById('gallery').innerHTML = '<div class="loading"><p>è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p></div>';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initGallery);
    </script>
</body>
</html>
